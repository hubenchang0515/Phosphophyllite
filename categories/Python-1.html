
<!DOCTYPE html>
<html lang="zh">
    <head>

        
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="icon" type="image/svg+xml" href="/Phosphophyllite/favicon.svg">
        
        

        
        <title>PlanC 的博客 - Python</title>
        <meta name="description" content="PlanC 的博客 - Python 分类 - 第 1 页">
        

        
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet" >
        <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/nord.min.css" rel="stylesheet">
        <link href="/Phosphophyllite/css/normalize.css" rel="stylesheet">
        <link href="/Phosphophyllite/css/bootstrap-quartz-theme.min.css" rel="stylesheet">
        <link href="/Phosphophyllite/css/github-markdown.css" rel="stylesheet">
        <link href="/Phosphophyllite/css/custom.css" rel="stylesheet">
        <link href="/Phosphophyllite/css/custom-dark.css" rel="stylesheet">
        
        
        
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
        <script src="/Phosphophyllite/js/custom.js"></script>
        

        <!-- Google tag (gtag.js) -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-HEWPX7E6EV"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', 'G-HEWPX7E6EV');
        </script>

        <script>
            
            document.oncopy = makeOnCopy("PlanC");
            
        </script>
    </head>

    <body class="d-flex flex-column">
        

<nav class="navbar navbar-expand-lg card no-print" data-bs-theme="dark" style="border-radius: 0;">
    <div class="container-fluid">
        <span class="navbar-brand">PlanC 的博客</span>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarColor01" aria-controls="navbarColor01" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarColor01">
            <ul class="navbar-nav me-auto">
                <li class="nav-item">
                    <a class="nav-link active" href="/Phosphophyllite/">首页</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="https://github.com/hubenchang0515" target="_blank">GitHub</a>
                </li>
            </ul>
            <form id='search-form' class="d-flex">
                <input id="search-input" name="q" class="form-control text-info me-sm-2" type="search" placeholder="Search" autocomplete="off">
            </form>
            <script>
                makeSearch("https://xplanc.org/Phosphophyllite", 'search-form', 'search-input')
            </script>
        </div>
    </div>
</nav>



        <div class="content d-flex flex-grow-1 m-2">
            <aside class="no-print left-side flex-shrink-0 d-flex flex-column"> 
            

<div class="card">
    <div class="card-body">
        <div style="margin: auto;">
            <img class="github-avatar" src="https://github.com/hubenchang0515.png"/>
            <h4 class="github-name card-title">PlanC</h4>
            <h6 class="github-username card-subtitle mb-2 text-muted">hubenchang0515</h6>
            <p class="github-brief card-text"></p>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <h4 class="card-title">文章分类</h4>
        <h6 class="card-subtitle mb-2 text-muted">Categories</h6>

        <div style="width: 100%;display: flex; flex-wrap: wrap; gap: 4px;">
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/Linux%20%E5%91%BD%E4%BB%A4%E4%B8%8E%E9%85%8D%E7%BD%AE-1.html">
                <span>
                    Linux 命令与配置
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    18
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/FreeRTOS-1.html">
                <span>
                    FreeRTOS
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    10
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/Qt-1.html">
                <span>
                    Qt
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    10
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/Linux%20API-1.html">
                <span>
                    Linux API
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    9
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/%E4%BB%A3%E7%90%86%E4%B8%8E%E9%95%9C%E5%83%8F%E6%BA%90%E9%85%8D%E7%BD%AE-1.html">
                <span>
                    代理与镜像源配置
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    9
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/%E9%BB%98%E8%AE%A4%E5%88%86%E7%B1%BB-1.html">
                <span>
                    默认分类
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    8
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/X11-1.html">
                <span>
                    X11
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    5
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/CUDA-1.html">
                <span>
                    CUDA
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    4
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/C%20%E8%AF%AD%E8%A8%80-1.html">
                <span>
                    C 语言
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    3
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/C%2B%2B-1.html">
                <span>
                    C++
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    3
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/CMake-1.html">
                <span>
                    CMake
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    3
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/MySQL-1.html">
                <span>
                    MySQL
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    3
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/Python-1.html">
                <span>
                    Python
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    3
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/Windows%20API-1.html">
                <span>
                    Windows API
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    3
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/%E6%B1%87%E7%BC%96-1.html">
                <span>
                    汇编
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    3
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/Docker-1.html">
                <span>
                    Docker
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    2
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/Minecraft-1.html">
                <span>
                    Minecraft
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    2
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/FreeType-1.html">
                <span>
                    FreeType
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    1
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/GitHub-1.html">
                <span>
                    GitHub
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    1
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/GitLab-1.html">
                <span>
                    GitLab
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    1
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/Golang-1.html">
                <span>
                    Golang
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    1
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/Kafka-1.html">
                <span>
                    Kafka
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    1
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/OpenCL-1.html">
                <span>
                    OpenCL
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    1
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/OpenGL-1.html">
                <span>
                    OpenGL
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    1
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/React-1.html">
                <span>
                    React
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    1
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/Windows%20%E5%91%BD%E4%BB%A4%E4%B8%8E%E9%85%8D%E7%BD%AE-1.html">
                <span>
                    Windows 命令与配置
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    1
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/nginx-1.html">
                <span>
                    nginx
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    1
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/%E8%B5%84%E6%BA%90%E5%88%86%E4%BA%AB-1.html">
                <span>
                    资源分享
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    1
                </span>
            </a>
            
        </div>
    </div>
</div>


            </aside>

            <main class="main-content flex-grow-1 flex-shrink-1 d-flex flex-column overflow-x-hidden">
                





    
        
        <div class="d-flex flex-column">
    <div class="no-print article-header d-flex px-1 text-nowrap" style="gap: 16px">
        <a class="fs-6 overflow-x-hidden text-white" href="/Phosphophyllite/articles/Python/DBus%20%E8%87%AA%E7%9C%81%20XML%20%E7%94%9F%E6%88%90%20Qt%20%E4%BB%A3%E7%A0%81.html"><i class="bi bi-box-arrow-up-right me-1"></i>DBus 自省 XML 生成 Qt 代码</a>
        <div style="flex-grow: 1; flex-shrink: 1;"></div>
        <div class="fs-6"><i class="bi bi-calendar"></i><span class="time ms-1">2024-12-18 21:18:31+08:00</span></div>
    </div>

    <div class="d-flex overflow-hidden" style="max-height: 300px;">
        <div class="no-print article-border-left"></div>
        <div class="article-preview markdown-body flex-grow-1 p-2" tabindex="1">
            <h1>DBus 自省 XML 生成 Qt 代码</h1>
<p>各种支持 DBus 的开发框架都能够通过 XML 自动生成代码，例如 Glib 的 <code>gdbus-codegen</code> 和 Qt 的 <code>qdbusxml2cpp</code>。</p>
<p>通过 DBus 对象 <code>org.freedesktop.DBus.Introspectable</code> 接口下的 <code>Introspect</code> 方法可以自省 XML，这样就不需要手写了。</p>
<p>但是 d-feet、dbus-send 等工具会给返回值加上类型标注或者换行符导致需要人工修改。因此需要自己写一个脚本来自省 DBus。</p>
<p>使用示例:</p>
<pre><code>$ ./introspect.py -t system -n org.freedesktop.NetworkManager -p /org/freedesktop/NetworkManager
$ ./introspect.py -t system -n org.freedesktop.NetworkManager -p /org/freedesktop/NetworkManager/Devices/5
$ ls -1
introspect.py  
org.freedesktop.NetworkManager.Device.Statistics.xml  
org.freedesktop.NetworkManager.Device.WifiP2P.xml  
org.freedesktop.NetworkManager.Device.xml
org.freedesktop.NetworkManager.xml
$ qdbusxml2cpp -c NetworkManager -p NetworkManager org.freedesktop.NetworkManager.xml --no-namespaces
$ qdbusxml2cpp -c Device -p Device org.freedesktop.NetworkManager.Device.xml --no-namespaces
$ qdbusxml2cpp -c WifiP2P -p WifiP2P org.freedesktop.NetworkManager.Device.WifiP2P.xml --no-namespaces
$ ls -1
Device.cpp
Device.h
introspect.py
NetworkManager.cpp
NetworkManager.h
org.freedesktop.NetworkManager.Device.Statistics.xml
org.freedesktop.NetworkManager.Device.WifiP2P.xml
org.freedesktop.NetworkManager.Device.xml
org.freedesktop.NetworkManager.xml
WifiP2P.cpp
WifiP2P.h
</code></pre>
<blockquote>
<p>使用 <code>--no-namespaces</code> 选项的原因是，<code>qdbusxml2cpp</code> 会把 DBus Name 的最后一项作为类名，而之前项作为命名空间名
即 <code>org.freedesktop.NetworkManager</code> 生成 <code>::org::freedesktop::NetworkManager</code> 类。
而 <code>org.freedesktop.NetworkManager.Device</code> 生成的 <code>::org::freedesktop::NetworkManager::Device</code> 类。
这两者会发生冲突。前者的 <code>NetworkManager</code> 是类名，而后者的是命名空间明。</p>
</blockquote>
<p>验证生成的代码:</p>
<pre><code class="language-cpp">#include &lt;QDebug&gt;
#include &quot;NetworkManager.h&quot;
#include &quot;Device.h&quot;
#include &quot;WifiP2P.h&quot;

int main(void)
{
    NetworkManager networkManager{&quot;org.freedesktop.NetworkManager&quot;, &quot;/org/freedesktop/NetworkManager&quot;, QDBusConnection::systemBus()};
    auto devicePathes = networkManager.devices();
    for (auto&amp; devicePath : devicePathes)
    {
        Device device(&quot;org.freedesktop.NetworkManager&quot;, devicePath.path(), QDBusConnection::systemBus());
        qDebug() &lt;&lt; &quot;check wifi p2p device&quot; &lt;&lt; devicePath.path();
        if (device.deviceType() == 30)
        {
            qDebug() &lt;&lt; &quot;found wifi p2p device&quot; &lt;&lt; devicePath.path();
            break;
        }
    }
}
</code></pre>
<pre><code>17:06:43: Starting /home/planc/miracast/build-wifi-p2p-unknown-Default/wifi-p2p...
check wifi p2p device &quot;/org/freedesktop/NetworkManager/Devices/1&quot;
check wifi p2p device &quot;/org/freedesktop/NetworkManager/Devices/2&quot;
check wifi p2p device &quot;/org/freedesktop/NetworkManager/Devices/5&quot;
found wifi p2p device &quot;/org/freedesktop/NetworkManager/Devices/5&quot;
17:06:43: /home/planc/miracast/build-wifi-p2p-unknown-Default/wifi-p2p exited with code 0
</code></pre>
<blockquote>
<p>如果看不到日志打印可以参考 <a href="https://gist.github.com/hubenchang0515/76508e9e3392110abbe9f7f78c213106">Qt 日志模块的使用</a> 进行配置</p>
</blockquote>
<pre><code class="language-python">#! /usr/bin/env python3
import dbus
from dbus.proxies import ProxyObject
import xml.dom.minidom as minidom
from typing import Callable, List, Set, Dict
from argparse import ArgumentParser, Namespace

# 不需要的 Interface
filter:Set[str] = {
    &quot;org.freedesktop.DBus.Introspectable&quot;,
    &quot;org.freedesktop.DBus.Peer&quot;,
    &quot;org.freedesktop.DBus.Properties&quot;,
}

class DBusTypeParser(object):
    dbusQtContainerType:Dict[str,str] = {
        &quot;&lt;array&gt;&quot;: &quot;QList&quot;,
        &quot;&lt;struct&gt;&quot;: &quot;QVariant&quot;,
        &quot;&lt;dict&gt;&quot;: &quot;QMap&quot;,
    }

    dbusQtType:Dict[str,str] = {
        &quot;y&quot;: &quot;quint8&quot;,
        &quot;b&quot;: &quot;bool&quot;,
        &quot;n&quot;: &quot;qint16&quot;,
        &quot;q&quot;: &quot;quint16&quot;,
        &quot;i&quot;: &quot;qint32&quot;,
        &quot;u&quot;: &quot;quint32&quot;,
        &quot;x&quot;: &quot;qint64&quot;,
        &quot;t&quot;: &quot;quint64&quot;,
        &quot;d&quot;: &quot;double&quot;,
        &quot;h&quot;: &quot;quint32&quot;,
        &quot;s&quot;: &quot;QString&quot;,
        &quot;o&quot;: &quot;QDBusObject&quot;,
        &quot;g&quot;: &quot;QString&quot;,
        &quot;v&quot;: &quot;QVariant&quot;,
    }

    def __init__(self) -&gt; None:
        # 状态
        self.currentState:str = &quot;&lt;normal&gt;&quot;
        self.stateStack:List[str] = []

        # dict里的第几个参数
        self.currentIndex:int = 0
        self.indexStack:List[int] = []

    def pushState(self, state:str) -&gt; None:
        if state == &quot;&lt;dict&gt;&quot;:
            self.pushIndex(self.currentIndex)
            self.currentIndex = 0
        self.stateStack.append(state)

    def popState(self) -&gt; str:
        state:str = self.stateStack.pop()
        if state == &quot;&lt;dict&gt;&quot;:
            self.currentIndex = self.popIndex()
        return state

    def pushIndex(self, index:int) -&gt; None:
        self.indexStack.append(index)

    def popIndex(self) -&gt; int:
        return self.indexStack.pop()

    def parse(self, signature:str) -&gt; str:
        self.currentState = &quot;&lt;normal&gt;&quot;
        self.currentIndex = 0
        qtype:str = &quot;&quot;
        while len(signature) &gt; 0:
            ch:str = signature[0]
            signature = signature[1:]

            if ch in DBusTypeParser.dbusQtType:
                if self.currentState == &quot;&lt;normal&gt;&quot;:
                    qtype += self.parseNormal(ch)
                elif self.currentState == &quot;&lt;struct&gt;&quot;:
                    qtype += self.parseStruct(ch)
                elif self.currentState == &quot;&lt;dict&gt;&quot;:
                    qtype += self.parseDict(ch)
                elif self.currentState == &quot;&lt;array&gt;&quot;:
                    qtype += self.parseArray(ch)
            elif ch == &quot;a&quot; and signature:
                if self.currentState == &quot;&lt;dict&gt;&quot; and self.currentIndex == 0:
                    qtype += DBusTypeParser.dbusQtContainerType['&lt;dict&gt;'] + &quot;&lt;&quot;
                self.pushState(self.currentState)
                self.currentState = &quot;&lt;array&gt;&quot;
            elif ch == &quot;(&quot;:
                if self.currentState == &quot;&lt;dict&gt;&quot; and self.currentIndex == 0:
                    qtype += DBusTypeParser.dbusQtContainerType['&lt;dict&gt;'] + &quot;&lt;&quot;
                self.pushState(self.currentState)
                self.currentState = &quot;&lt;struct&gt;&quot;
            elif ch == &quot;{&quot;:
                # a{ 开启dict模式，之前为暂态的array模式，不push
                self.currentState = &quot;&lt;dict&gt;&quot;
            elif ch == &quot;)&quot;:
                qtype += self.parseStruct(ch)
                if self.currentState == &quot;&lt;dict&gt;&quot; and self.currentIndex == 0:
                    qtype += &quot;, &quot;
                    self.currentIndex += 1
            elif ch == &quot;}&quot;:
                self.currentState = self.popState()
                qtype += self.parseDict(ch)
                if self.currentState == &quot;&lt;dict&gt;&quot; and self.currentIndex == 0:
                    qtype += &quot;, &quot;
                    self.currentIndex += 1
            else:
                print(f&quot;{ch}&quot;)
                raise f&quot;Unknown signature '{ch}'&quot;
        return qtype

    def parseNormal(self, ch:str) -&gt; str:
        return DBusTypeParser.dbusQtType[ch]
        
    def parseArray(self, ch:str) -&gt; str:
        self.currentState = self.popState()
        return f&quot;{DBusTypeParser.dbusQtContainerType['&lt;array&gt;']}&lt;{DBusTypeParser.dbusQtType[ch]}&gt;&quot;

    def parseStruct(self, ch:str) -&gt; str:
        if ch != &quot;)&quot;:
            return &quot;&quot;

        self.currentState = self.popState()
        if self.currentState == &quot;&lt;struct&gt;&quot;:
            return &quot;&quot;

        if self.currentState == &quot;&lt;normal&gt;&quot;:
            return DBusTypeParser.dbusQtContainerType[&quot;&lt;struct&gt;&quot;]

        if self.currentState == &quot;&lt;dict&gt;&quot;:
            return DBusTypeParser.dbusQtContainerType[&quot;&lt;struct&gt;&quot;]

        if self.currentState == &quot;&lt;array&gt;&quot;:
            self.currentState = self.popState()
            return f&quot;{DBusTypeParser.dbusQtContainerType['&lt;array&gt;']}&lt;{DBusTypeParser.dbusQtContainerType['&lt;struct&gt;']}&gt;&quot;

    def parseDict(self, ch:str) -&gt; str:
        if ch == &quot;}&quot;:
            return &quot;&gt;&quot;

        self.currentIndex += 1
        if self.currentIndex == 1:
            return DBusTypeParser.dbusQtContainerType['&lt;dict&gt;'] + &quot;&lt;&quot; + DBusTypeParser.dbusQtType[ch] + &quot;, &quot;
        else:
            return DBusTypeParser.dbusQtType[ch]

dbusTypeParser = DBusTypeParser()

parser:ArgumentParser = ArgumentParser(description='DBus Introspect XML')
parser.add_argument(&quot;-t&quot;, &quot;--type&quot;, default=&quot;session&quot;, help=&quot;bus type, system or session&quot;)
parser.add_argument(&quot;-n&quot;, &quot;--name&quot;, help=&quot;bus namae&quot;)
parser.add_argument(&quot;-p&quot;, &quot;--path&quot;, help=&quot;object path&quot;)
args:Namespace = parser.parse_args()

bus:dbus.Bus = dbus.SystemBus() if args.type == &quot;system&quot; else dbus.SessionBus() 
proxy:ProxyObject = bus.get_object(args.name, args.path)
xmlString:str = proxy.Introspect(dbus_interface='org.freedesktop.DBus.Introspectable')

root:minidom.Document = minidom.parseString(xmlString)
interfaces:List[minidom.Element] = root.getElementsByTagName(&quot;interface&quot;)

neededInterfaces:List[minidom.Element] = []
for interface in interfaces:
    name:str = interface.getAttribute(&quot;name&quot;)
    if name in filter:
        continue

    methods:List[minidom.Element] = interface.getElementsByTagName(&quot;method&quot;)
    for method in methods:
        inIndex:int = 0
        outIndex:int = 0
        methodArgs:List[minidom.Element] = method.getElementsByTagName(&quot;arg&quot;)
        for arg in methodArgs:
            sign:str = arg.getAttribute(&quot;type&quot;)
            qtype:str = dbusTypeParser.parse(sign)
            annotation:minidom.Element = root.createElement(&quot;annotation&quot;)
            
            if arg.getAttribute(&quot;direction&quot;) == &quot;in&quot;:
                annotation.setAttribute(&quot;name&quot;, f&quot;org.qtproject.QtDBus.QtTypeName.In{inIndex}&quot;)
                inIndex += 1
            if arg.getAttribute(&quot;direction&quot;) == &quot;out&quot;:
                annotation.setAttribute(&quot;name&quot;, f&quot;org.qtproject.QtDBus.QtTypeName.Out{outIndex}&quot;)
                outIndex += 1

            annotation.setAttribute(&quot;value&quot;, qtype)
            method.appendChild(annotation)

    properties = interface.getElementsByTagName(&quot;property&quot;)
    for property in properties:
        sign:str = property.getAttribute(&quot;type&quot;)
        qtype:str = dbusTypeParser.parse(sign)
        annotation:minidom.Element = root.createElement(&quot;annotation&quot;)
        annotation.setAttribute(&quot;name&quot;, &quot;org.qtproject.QtDBus.QtTypeName&quot;)
        annotation.setAttribute(&quot;value&quot;, qtype)
        property.appendChild(annotation)
    
    neededInterfaces.append(interface)


for interface in neededInterfaces:
    with open(interface.getAttribute(&quot;name&quot;) + &quot;.xml&quot;, &quot;w&quot;) as fp:
        fp.write(interface.toprettyxml())
</code></pre>

        </div>
        <div class="no-print article-border-right"></div>
    </div>

    <div class="no-print article-border-bottom"></div>
</div>
    



    
        
        <div class="d-flex flex-column">
    <div class="no-print article-header d-flex px-1 text-nowrap" style="gap: 16px">
        <a class="fs-6 overflow-x-hidden text-white" href="/Phosphophyllite/articles/Python/Python%20%E5%AF%BB%E7%8E%AF%E5%A2%83%E4%B8%8E%E4%BE%9D%E8%B5%96%E5%AF%BC%E5%87%BA.html"><i class="bi bi-box-arrow-up-right me-1"></i>Python 寻环境与依赖导出</a>
        <div style="flex-grow: 1; flex-shrink: 1;"></div>
        <div class="fs-6"><i class="bi bi-calendar"></i><span class="time ms-1">2024-12-18 21:18:31+08:00</span></div>
    </div>

    <div class="d-flex overflow-hidden" style="max-height: 300px;">
        <div class="no-print article-border-left"></div>
        <div class="article-preview markdown-body flex-grow-1 p-2" tabindex="2">
            <h1>Python 虚拟环境与依赖导出</h1>
<p>因为不同的项目之间可能存在依赖冲突，因此需要使用虚拟环境，避免在全局环境上安装依赖。</p>
<h2>Python 依赖导出</h2>
<p>通过 <code>pipreqs</code> 可以将当前项目依赖的所有包导出到 <code>requirements.txt</code> 中：</p>
<pre><code>$ pipreqs . --encoding=utf8 --force 
</code></pre>
<blockquote>
<p>注意，如果在当前路径下配置了虚拟环境，pipreqs 会读取寻环境的目录产生多余的依赖，需要添加 <code>--ignore .venv</code> 参数来消除影响<br />
可以使用 <code>--proxy http://localhost:7890</code> 来配置代理</p>
</blockquote>
<p>然后通过该文件即可一键安装所有依赖</p>
<pre><code>$ pip install -r requirements.txt
</code></pre>
<h2>virtualenv</h2>
<ol>
<li>安装</li>
</ol>
<pre><code>pip install virtualenv
</code></pre>
<ol start="2">
<li>创建</li>
</ol>
<pre><code>virtualenv [虚拟环境名称] 
</code></pre>
<ol start="3">
<li>激活</li>
</ol>
<pre><code>cd [虚拟环境目录]
source ./bin/activate
</code></pre>
<ol start="4">
<li>退出</li>
</ol>
<pre><code>deactivate
</code></pre>
<h2>pipenv</h2>
<ol>
<li>安装</li>
</ol>
<pre><code>pip install pipenv
</code></pre>
<ol start="2">
<li>创建</li>
</ol>
<pre><code>pipenv install
</code></pre>
<blockquote>
<p>在项目目录里执行，如果没有 <code>pipfile</code>，则会创建；如果有则会安装记录在当中的依赖</p>
</blockquote>
<ol start="3">
<li>安装依赖包</li>
</ol>
<pre><code>pipenv install [包名]
</code></pre>
<blockquote>
<p>在项目目录里执行，安装依赖的同时记录到 <code>pipfile</code> 中去，如果文件不存在则自动创建</p>
</blockquote>
<ol start="4">
<li>激活</li>
</ol>
<pre><code>pipenv shell
</code></pre>
<hr />
<blockquote>
<p>另外还有 <code>virtualenvwrapper</code>、<code>conda</code> 可以管理虚拟环境，此处暂不列出。</p>
</blockquote>

        </div>
        <div class="no-print article-border-right"></div>
    </div>

    <div class="no-print article-border-bottom"></div>
</div>
    



    
        
        <div class="d-flex flex-column">
    <div class="no-print article-header d-flex px-1 text-nowrap" style="gap: 16px">
        <a class="fs-6 overflow-x-hidden text-white" href="/Phosphophyllite/articles/Python/Python%E7%9A%84%E5%BC%82%E6%AD%A5IO.html"><i class="bi bi-box-arrow-up-right me-1"></i>Python的异步IO</a>
        <div style="flex-grow: 1; flex-shrink: 1;"></div>
        <div class="fs-6"><i class="bi bi-calendar"></i><span class="time ms-1">2024-12-18 21:18:31+08:00</span></div>
    </div>

    <div class="d-flex overflow-hidden" style="max-height: 300px;">
        <div class="no-print article-border-left"></div>
        <div class="article-preview markdown-body flex-grow-1 p-2" tabindex="3">
            <h1>Python的异步IO</h1>
<h2>协程</h2>
<p>Python 的异步 I/O 基于协程实现。使用<code>async</code>关键字来创建一个异步函数，对异步函数的调用不会执行该函数，而是生成一个协程对象。<br />
对每一个协程对象，都必须等待其结束(即使是没有启动的协程)，否则会产生一个<code>RuntimeWarning</code>。</p>
<p>示例 :</p>
<pre><code class="language-python"># 创建一个异步函数
async def say_hello():
    print(&quot;hello world&quot;)

# 创建协程
coro = say_hello()
print(coro)
</code></pre>
<p>运行结果 :</p>
<pre><code>&lt;coroutine object say_hello at 0x109bf6170&gt;
sys:1: RuntimeWarning: coroutine 'say_hello' was never awaited
</code></pre>
<p>要启动一个协程，有三种方式 :</p>
<ul>
<li>通过<code>asyncio.run</code>运行一个协程</li>
<li>使用<code>await</code>关键字，这种方法只能在另一个<code>async</code>函数中才能使用</li>
<li>通过<code>asyncio.create_task</code></li>
</ul>
<blockquote>
<p><code>await</code>必须在<code>async</code>函数中才能使用，因此无法启动协程的顶层入口点，此时只能使用<code>asyncio.run</code>函数。</p>
<p><code>await</code>让出当前协程并运行目标协程，当前协程直到目标目标的状态变为<code>done</code>时才会恢复就绪。
如果<code>await</code>的目标不是一个协程(例如Task和Future)，让出当前协程后，事件循环(<code>EventLoop</code>)会从就绪队列中选择一个协程运行。</p>
<p><code>asyncio.create_task</code>让出当前协程并运行目标协程，当前协程不会等待而是加入就绪队列。<br />
只要目标协程让出，当前协程就有机会执行，从而将启动多个协程，实现并发执行。<br />
返回的<code>Task</code>对象也可以在适当的时候使用<code>await</code>等待其结束。</p>
</blockquote>
<p>简化的协程状态 :</p>
<p><img src="https://user-images.githubusercontent.com/11847852/222871658-fdd0d4da-1c76-431c-b3d7-0aea36d75e93.png" alt="协程状态" /></p>
<p><code>await</code>的示例 :</p>
<pre><code class="language-python">import asyncio
import time

async def say_hello():
    print(&quot;hello&quot;, time.strftime('%X'))
    await asyncio.sleep(1)
    print(&quot;hello&quot;, time.strftime('%X'))

async def say_world():
    print(&quot;world&quot;, time.strftime('%X'))
    await asyncio.sleep(1)
    print(&quot;world&quot;, time.strftime('%X'))

# 顶层入口点
async def main():
    await say_hello() # 启动say_hello()返回的协程，并等待其结束
    await say_world() # 要等到前一个await结束后，才会启动

# 启动顶层入口点
asyncio.run(main())
</code></pre>
<p>运行结果 :</p>
<pre><code>hello 15:27:26
hello 15:27:27
world 15:27:27
world 15:27:28
</code></pre>
<p><code>asyncio.create_task</code>的示例 :</p>
<pre><code class="language-python">import asyncio
import time

async def say_hello():
    print(&quot;hello&quot;, time.strftime('%X'))
    await asyncio.sleep(1)
    print(&quot;hello&quot;, time.strftime('%X'))

async def say_world():
    print(&quot;world&quot;, time.strftime('%X'))
    await asyncio.sleep(1)
    print(&quot;world&quot;, time.strftime('%X'))

# 顶层入口点
async def main():
    task_say_hello = asyncio.create_task(say_hello()) # 启动协程不等待
    task_say_world = asyncio.create_task(say_world()) 

    await task_say_hello
    await task_say_world

# 启动顶层入口点
asyncio.run(main())
</code></pre>
<p>运行结果 :</p>
<pre><code>hello 15:29:41
world 15:29:41
hello 15:29:42
world 15:29:42
</code></pre>
<p>通过上面两个示例打印的顺序和时间可以看出<code>await</code>和<code>asyncio.create_task</code>的区别</p>
<p>本来准备介绍一下<code>asyncio</code>中的TCP和UDP接口，但是抄袭官方文档没有意义，而且我懒得写了，下面是一个TCP server的示例，旨在演示如何使用协程并发处理客户请求。</p>
<p>在<code>/block</code>的请求处理函数中有一个延时10秒的操作(<code>await asyncio.sleep(delay)</code>)，但是因为使用异步操作进行，所有不需要等待它结束就能相应其它请求。</p>
<ul>
<li><code>await asyncio.sleep(delay)</code>将当前协程让出，运行<code>asyncio.sleep(delay)</code>返回的协程。</li>
<li><code>asyncio.sleep(delay)</code>返回的协程里，会创建一个<code>Future</code>对象，并在<code>EventLoop</code>中注册(<code>EventLoop</code>将在<code>delay</code>秒后将<code>Future</code>对象的状态设为<code>done</code>
)，之后<code>await future</code>让出，等待<code>future</code>的状态变为<code>done</code>。</li>
<li>由于目标不是协程，<code>EventLoop</code>会从就绪队列中选取一个协程来运行，因此可以对新的请求做出相应。</li>
</ul>
<pre><code class="language-python">import asyncio
import re

class DemoProtocol(asyncio.Protocol):
    # 获取url的正则
    url_re = re.compile(b'GET (.*) HTTP/1.1')

    # 连接创建时的回调函数
    def connection_made(self, transport):
        peername = transport.get_extra_info('peername')
        print('Connection from {}'.format(peername))
        self.transport = transport

    # 收到数据时的回调函数
    def data_received(self, data):
        # 获取url
        url = DemoProtocol.url_re.match(data).group(1)
        print(&quot;GET&quot;, url)
        # 根据url做不同的处理
        if url == b&quot;/block&quot; :
            # 10s后响应
            asyncio.create_task(self.response_after(b'&lt;h1&gt;Are you block?&lt;/h1&gt;', 10))
        else:
            asyncio.create_task(self.response(b'&lt;h1&gt;hello world&lt;/h1&gt;'))

    # 立刻返回响应
    async def response(self, content):
        self.transport.write(b&quot;HTTP/1.1 200 OK\r\n&quot;)
        self.transport.write(b&quot;Content-Type: text/html\r\n&quot;)
        self.transport.write(b&quot;\r\n&quot;)
        self.transport.write(content)
        self.transport.write(b&quot;\r\n&quot;)
        self.transport.close()

    # 延迟返回响应
    async def response_after(self, content, delay):
        await asyncio.sleep(delay)
        await self.response(content)


async def main():
    # Get a reference to the event loop as we plan to use
    # low-level APIs.
    loop = asyncio.get_running_loop()

    server = await loop.create_server(lambda: DemoProtocol(), '127.0.0.1', 8888)

    async with server:
        await server.serve_forever()

asyncio.run(main())
</code></pre>

        </div>
        <div class="no-print article-border-right"></div>
    </div>

    <div class="no-print article-border-bottom"></div>
</div>
    



<div>
    <ul class="pagination float-end">
        
        <li class="page-item disabled">
            <a class="page-link" href="#"><i class="bi bi-chevron-double-left"></i></a>
        </li>
        

        
            
            
        
            
            
        
            
            <li class="page-item active">
                <a class="page-link" href="/Phosphophyllite/categories/Python-1.html">1</a>
            </li>
            
        
            
            
        
            
            
        

        
        <li class="page-item disabled">
            <a class="page-link" href="#"><i class="bi bi-chevron-double-right"></i></a>
        </li>
        
    </ul>
</div>


            </main>

            <aside class="no-print right-side flex-shrink-0 d-flex flex-column">
            

<div class="card">
    <img src="https://github-readme-stats.vercel.app/api?username=hubenchang0515&theme=transparent&hide_border=true&show_icons=true&card_width=400"/>
</div>

<div class="card">
    <img src="https://github-readme-stats.vercel.app/api/top-langs/?username=hubenchang0515&layout=compact&theme=transparent&hide_border=true&card_width=400&langs_count=32&size_weight=0.1&count_weight=0.9&hide=cmake%2Cqmake%2Cmakefile%2Cshell%2Cobjective-c"/>
</div>

<div class="card">
    <div class="card-body">
        <h4 class="card-title">导航</h4>
        <h6 class="card-subtitle mb-2 text-muted">Navigation</h6>
        <div class="d-flex flex-wrap" style="gap: 8px;">
            
            <a class="link-info" href="https://hubenchang0515.github.io/" target="_blank"><i class="bi bi-link-45deg"></i> 主页</a>
            
            <a class="link-info" href="https://hubenchang0515.github.io/primers/" target="_blank"><i class="bi bi-link-45deg"></i> Primers 编程教程</a>
            
            <a class="link-info" href="https://hubenchang0515.github.io/QtTheme/" target="_blank"><i class="bi bi-link-45deg"></i> QtTheme</a>
            
            <a class="link-info" href="https://hubenchang0515.github.io/shift/" target="_blank"><i class="bi bi-link-45deg"></i> Shift 在线编程</a>
            
            <a class="link-info" href="https://hubenchang0515.github.io/moe-tools/" target="_blank"><i class="bi bi-link-45deg"></i> 萌萌工具箱</a>
            
            <a class="link-info" href="https://hubenchang0515.github.io/friends/" target="_blank"><i class="bi bi-link-45deg"></i> 友情链接</a>
            
        </div>
    </div>
</div>

<div class="card sticky">
    <div class="card-body">
        <h4 class="card-title">最近文章</h4>
        <h6 class="card-subtitle mb-2 text-muted">Recent Articles</h6>
        <ul>
            
            <li>
                <a class="link-info" href="/Phosphophyllite/articles/React/MUI%20%E9%9B%86%E6%88%90%20nextjs.html">MUI 集成 nextjs</a>
            </li>
            
            <li>
                <a class="link-info" href="/Phosphophyllite/articles/MySQL/MySQL%20%E5%85%A8%E6%96%87%E7%B4%A2%E5%BC%95.html">MySQL 全文索引</a>
            </li>
            
            <li>
                <a class="link-info" href="/Phosphophyllite/articles/%E8%B5%84%E6%BA%90%E5%88%86%E4%BA%AB/%E5%9C%A8%20eu.org%20%E6%B3%A8%E5%86%8C%E5%85%8D%E8%B4%B9%E5%9F%9F%E5%90%8D.html">在 eu.org 注册免费域名</a>
            </li>
            
            <li>
                <a class="link-info" href="/Phosphophyllite/articles/MySQL/MySQL%20%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9F%BA%E7%A1%80%E5%91%BD%E4%BB%A4.html">MySQL 数据库基础命令</a>
            </li>
            
            <li>
                <a class="link-info" href="/Phosphophyllite/articles/MySQL/MySQL%20%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%9D%E5%A7%8B%E5%8C%96.html">MySQL 数据库初始化</a>
            </li>
            
            <li>
                <a class="link-info" href="/Phosphophyllite/articles/Minecraft/%E4%BD%BF%E7%94%A8%20Tan90-Proxy%20%E4%BB%A3%E7%90%86%20Minecraft%20%E6%9C%8D%E5%8A%A1%E5%99%A8.html">使用 Tan90-Proxy 代理 Minecraft 服务器</a>
            </li>
            
            <li>
                <a class="link-info" href="/Phosphophyllite/articles/Minecraft/Minecraft%20%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8B%E8%BD%BD%E9%A1%B5%E5%9C%B0%E5%9D%80.html">Minecraft 服务器下载页地址</a>
            </li>
            
            <li>
                <a class="link-info" href="/Phosphophyllite/articles/nginx/nginx%20%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E4%B8%8E%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE.html">nginx 常用命令与基础配置</a>
            </li>
            
            <li>
                <a class="link-info" href="/Phosphophyllite/articles/Linux%20%E5%91%BD%E4%BB%A4%E4%B8%8E%E9%85%8D%E7%BD%AE/%E5%88%B6%E4%BD%9C%20deb%20%E5%8C%85.html">制作 deb 包</a>
            </li>
            
            <li>
                <a class="link-info" href="/Phosphophyllite/articles/Windows%20%E5%91%BD%E4%BB%A4%E4%B8%8E%E9%85%8D%E7%BD%AE/Windows%20%E6%B3%A8%E5%86%8C%E8%A1%A8%E4%B8%AD%E6%B7%BB%E5%8A%A0%E8%87%AA%E5%B7%B1%E7%9A%84%E7%A8%8B%E5%BA%8F.html">Windows 注册表中添加自己的程序</a>
            </li>
            
        </ul>
    </div>
</div>


            </aside>
        </div>

        <footer class="no-print">
            

<div class="card" style="border-radius: 0;">
    <p class="github-brief card-text" style="margin: auto;">
        Powered by <i class="bi bi-arrow-through-heart-fill"></i> <a class="card-link link-success" href="https://github.com/hubenchang0515/Phosphophyllite" target="_blank">Phosphophyllite</a>
    </p>
</div>


        </footer>

        

<script>
    fetchUserInfo("hubenchang0515");
    scanTime();
</script>


    </body>
</html>