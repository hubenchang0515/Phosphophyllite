
<!DOCTYPE html>
<html lang="zh">
    <head>

        
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="icon" type="image/svg+xml" href="/Phosphophyllite/favicon.svg">
        
        

        
        <title>PlanC 的博客 - C++</title>
        <meta name="description" content="PlanC 的博客 - C++ 分类 - 第 1 页">
        

        
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet" >
        <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/nord.min.css" rel="stylesheet">
        <link href="/Phosphophyllite/css/normalize.css" rel="stylesheet">
        <link href="/Phosphophyllite/css/bootstrap-quartz-theme.min.css" rel="stylesheet">
        <link href="/Phosphophyllite/css/github-markdown.css" rel="stylesheet">
        <link href="/Phosphophyllite/css/custom.css" rel="stylesheet">
        <link href="/Phosphophyllite/css/custom-dark.css" rel="stylesheet">
        
        
        
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
        <script src="/Phosphophyllite/js/custom.js"></script>
        

        <!-- Google tag (gtag.js) -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-HEWPX7E6EV"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', 'G-HEWPX7E6EV');
        </script>

        <script>
            
            document.oncopy = makeOnCopy("PlanC");
            
        </script>
    </head>

    <body class="d-flex flex-column">
        

<nav class="navbar navbar-expand-lg card no-print" data-bs-theme="dark" style="border-radius: 0;">
    <div class="container-fluid">
        <span class="navbar-brand">PlanC 的博客</span>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarColor01" aria-controls="navbarColor01" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarColor01">
            <ul class="navbar-nav me-auto">
                <li class="nav-item">
                    <a class="nav-link active" href="/Phosphophyllite/">首页</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="https://github.com/hubenchang0515" target="_blank">GitHub</a>
                </li>
            </ul>
            <form id='search-form' class="d-flex">
                <input id="search-input" name="q" class="form-control text-info me-sm-2" type="search" placeholder="Search" autocomplete="off">
            </form>
            <script>
                makeSearch("https://xplanc.org/Phosphophyllite", 'search-form', 'search-input')
            </script>
        </div>
    </div>
</nav>



        <div class="content d-flex flex-grow-1 m-2">
            <aside class="no-print left-side flex-shrink-0 d-flex flex-column"> 
            

<div class="card">
    <div class="card-body">
        <div style="margin: auto;">
            <img class="github-avatar" src="https://github.com/hubenchang0515.png"/>
            <h4 class="github-name card-title">PlanC</h4>
            <h6 class="github-username card-subtitle mb-2 text-muted">hubenchang0515</h6>
            <p class="github-brief card-text"></p>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <h4 class="card-title">文章分类</h4>
        <h6 class="card-subtitle mb-2 text-muted">Categories</h6>

        <div style="width: 100%;display: flex; flex-wrap: wrap; gap: 4px;">
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/Linux%20%E5%91%BD%E4%BB%A4%E4%B8%8E%E9%85%8D%E7%BD%AE-1.html">
                <span>
                    Linux 命令与配置
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    18
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/FreeRTOS-1.html">
                <span>
                    FreeRTOS
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    10
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/Qt-1.html">
                <span>
                    Qt
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    10
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/Linux%20API-1.html">
                <span>
                    Linux API
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    9
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/%E4%BB%A3%E7%90%86%E4%B8%8E%E9%95%9C%E5%83%8F%E6%BA%90%E9%85%8D%E7%BD%AE-1.html">
                <span>
                    代理与镜像源配置
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    9
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/%E9%BB%98%E8%AE%A4%E5%88%86%E7%B1%BB-1.html">
                <span>
                    默认分类
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    8
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/X11-1.html">
                <span>
                    X11
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    5
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/CUDA-1.html">
                <span>
                    CUDA
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    4
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/C%20%E8%AF%AD%E8%A8%80-1.html">
                <span>
                    C 语言
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    3
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/C%2B%2B-1.html">
                <span>
                    C++
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    3
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/CMake-1.html">
                <span>
                    CMake
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    3
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/MySQL-1.html">
                <span>
                    MySQL
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    3
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/Python-1.html">
                <span>
                    Python
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    3
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/Windows%20API-1.html">
                <span>
                    Windows API
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    3
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/%E6%B1%87%E7%BC%96-1.html">
                <span>
                    汇编
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    3
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/Docker-1.html">
                <span>
                    Docker
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    2
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/Minecraft-1.html">
                <span>
                    Minecraft
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    2
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/FreeType-1.html">
                <span>
                    FreeType
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    1
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/GitHub-1.html">
                <span>
                    GitHub
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    1
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/GitLab-1.html">
                <span>
                    GitLab
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    1
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/Golang-1.html">
                <span>
                    Golang
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    1
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/Kafka-1.html">
                <span>
                    Kafka
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    1
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/OpenCL-1.html">
                <span>
                    OpenCL
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    1
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/OpenGL-1.html">
                <span>
                    OpenGL
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    1
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/React-1.html">
                <span>
                    React
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    1
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/Windows%20%E5%91%BD%E4%BB%A4%E4%B8%8E%E9%85%8D%E7%BD%AE-1.html">
                <span>
                    Windows 命令与配置
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    1
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/nginx-1.html">
                <span>
                    nginx
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    1
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/%E8%B5%84%E6%BA%90%E5%88%86%E4%BA%AB-1.html">
                <span>
                    资源分享
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    1
                </span>
            </a>
            
        </div>
    </div>
</div>


            </aside>

            <main class="main-content flex-grow-1 flex-shrink-1 d-flex flex-column overflow-x-hidden">
                





    
        
        <div class="d-flex flex-column">
    <div class="no-print article-header d-flex px-1 text-nowrap" style="gap: 16px">
        <a class="fs-6 overflow-x-hidden text-white" href="/Phosphophyllite/articles/C%2B%2B/C%2B%2B%20%E5%87%BD%E6%95%B0%E6%B6%88%E6%8A%96.html"><i class="bi bi-box-arrow-up-right me-1"></i>C++ 函数消抖</a>
        <div style="flex-grow: 1; flex-shrink: 1;"></div>
        <div class="fs-6"><i class="bi bi-calendar"></i><span class="time ms-1">2024-12-22 20:52:07+08:00</span></div>
    </div>

    <div class="d-flex overflow-hidden" style="max-height: 300px;">
        <div class="no-print article-border-left"></div>
        <div class="article-preview markdown-body flex-grow-1 p-2" tabindex="1">
            <h1>C++ 函数消抖</h1>
<p><strong>函数消抖</strong> 指在短时间内连续多次调用同一函数，仅最后一次调用生效。</p>
<p>形如:</p>
<pre><code class="language-c++">auto debouncedFn = debounce(fn, 100);
</code></pre>
<p>通常将需要消抖的函数封装成一个新的函数，新的函数进行延迟后调用原函数:</p>
<ul>
<li>如果在延时结束前再次调用，则重新开始延时</li>
<li>如果在延时结束前没有再次调用，则使调用原函数</li>
</ul>
<h2>示例</h2>
<blockquote>
<p>这个实现存在一个问题，那就是通过 <code>thread.join();</code> 等待上一次调用取消，会产生阻塞，不能用于实际开发。</p>
</blockquote>
<pre><code class="language-c++">#include &lt;functional&gt;
#include &lt;chrono&gt;
#include &lt;thread&gt;
#include &lt;mutex&gt;
#include &lt;future&gt;
#include &lt;memory&gt;
#include &lt;exception&gt;

namespace Utils
{

template&lt;typename R, typename... ARGS&gt;
std::enable_if_t&lt;!std::is_void_v&lt;R&gt; &amp;&amp; (!std::is_void_v&lt;ARGS&gt; &amp;&amp; ...), void&gt;
invoke(std::shared_ptr&lt;std::promise&lt;R&gt;&gt; promise, std::function&lt;R(ARGS...)&gt; fn, ARGS... args)
{
    promise-&gt;set_value(fn(args...));
}

template&lt;typename R&gt;
void invoke(std::shared_ptr&lt;std::promise&lt;R&gt;&gt; promise, std::function&lt;R(void)&gt; fn)
{
    promise-&gt;set_value(fn());
}

template&lt;typename... ARGS&gt;
void invoke(std::shared_ptr&lt;std::promise&lt;void&gt;&gt; promise, std::function&lt;void(ARGS...)&gt; fn, ARGS... args)
{
    fn(args...);
    promise-&gt;set_value();
}

void invoke(std::shared_ptr&lt;std::promise&lt;void&gt;&gt; promise, std::function&lt;void(void)&gt; fn)
{
    fn();
    promise-&gt;set_value();
}

/*************************************************************************
 * @brief 函数消抖
 * @param fn 希望消抖函数
 * @param ms 消抖的延时时间，毫秒
 * @return 一个封装了消抖功能的函数
 *************************************************************************/
template&lt;typename R, typename... ARGS&gt;
std::function&lt;std::shared_ptr&lt;std::promise&lt;R&gt;&gt;(ARGS...)&gt; debounce(std::function&lt;R(ARGS...)&gt; fn, int ms)
{
    auto lambda = [fn = std::move(fn), ms](ARGS... args) mutable -&gt; std::shared_ptr&lt;std::promise&lt;R&gt;&gt; {
        std::shared_ptr&lt;std::promise&lt;R&gt;&gt; promise = std::make_shared&lt;std::promise&lt;R&gt;&gt;();
        static auto lastCallTime = std::chrono::steady_clock::now();
        static bool cancel = false;
        static std::thread thread;
        static std::mutex mutex;

        if (thread.joinable())
        {
            mutex.lock();
            cancel = true;
            mutex.unlock();

            thread.join();

            mutex.lock();
            cancel = false;
            mutex.unlock();
        }

        thread = std::thread([fn, ms, promise, args...]() mutable {
            std::this_thread::sleep_until(lastCallTime + std::chrono::milliseconds(ms));

            mutex.lock();
            if (cancel)
            {
                mutex.unlock();
                promise-&gt;set_exception(std::make_exception_ptr(std::runtime_error(&quot;cancel&quot;)));
                return;
            }
            mutex.unlock();

            // promise-&gt;set_value(fn(args...));
            invoke(promise, fn, args...);
            thread.detach();
        });

        return promise;
    };

    return lambda;
}

template&lt;typename R, typename... ARGS&gt;
std::function&lt;std::shared_ptr&lt;std::promise&lt;R&gt;&gt;(ARGS...)&gt; debounce(R(*fn)(ARGS...), int ms)
{
    return debounce(static_cast&lt;std::function&lt;R(ARGS...)&gt;&gt;(fn), ms);
}

}; // namespace Utils
</code></pre>
<h2>测试</h2>
<pre><code class="language-c++">int main()
{
    auto fn = Utils::debounce(test, 1000);
    auto p1 = fn(1, 2);
    auto p2 = fn(3, 4);

    auto f1 = p1-&gt;get_future();
    auto f2 = p2-&gt;get_future();

    f1.wait();
    f2.wait();

    try {
        if (f1.valid())
            printf(&quot;%d\n&quot;, f1.get());
    } catch (std::runtime_error e) {
        printf(&quot;%s\n&quot;, e.what());
    }

    try {
        if (f2.valid())
            printf(&quot;%d\n&quot;, f2.get());
    } catch (std::runtime_error e) {
        printf(&quot;%s\n&quot;, e.what());
    }

    return 0;
}
</code></pre>
<p>结果:</p>
<pre><code>test 3 4
cancel
7
</code></pre>

        </div>
        <div class="no-print article-border-right"></div>
    </div>

    <div class="no-print article-border-bottom"></div>
</div>
    



    
        
        <div class="d-flex flex-column">
    <div class="no-print article-header d-flex px-1 text-nowrap" style="gap: 16px">
        <a class="fs-6 overflow-x-hidden text-white" href="/Phosphophyllite/articles/C%2B%2B/C%2B%2B%20%E5%AE%B9%E5%99%A8%E5%86%85%E5%85%83%E7%B4%A0%E9%87%8D%E5%A4%8D%E6%9E%90%E6%9E%84%E7%9A%84%E9%97%AE%E9%A2%98.html"><i class="bi bi-box-arrow-up-right me-1"></i>C++ 容器内元素重复析构的问题</a>
        <div style="flex-grow: 1; flex-shrink: 1;"></div>
        <div class="fs-6"><i class="bi bi-calendar"></i><span class="time ms-1">2024-12-18 21:18:31+08:00</span></div>
    </div>

    <div class="d-flex overflow-hidden" style="max-height: 300px;">
        <div class="no-print article-border-left"></div>
        <div class="article-preview markdown-body flex-grow-1 p-2" tabindex="2">
            <h1>C++ 容器内元素重复析构的问题</h1>
<h2>说明</h2>
<p><code>std::vector</code> 这种连续空间的容器，当空间不足时需要整体重新分配内存，并将旧的数据迁移过去。
首先会使用 <code>std::move_if_noexcept</code> 尝试进行移动。
因此如果元素类型的移动构造函数没有标明 <code>noexcept</code> 则不会被调用。
之后会通过 <code>std::uninitialized_copy</code> 尝试进行拷贝。</p>
<blockquote>
<p>这是因为移动中如果产生异常，部分源数据已经被移动，将无法恢复原状。而拷贝中如果发生异常，源数据不应改变，只要返回失败即可。</p>
</blockquote>
<p>参考:</p>
<ul>
<li><a href="https://en.cppreference.com/w/cpp/language/move_constructor">Move constructors</a></li>
<li><a href="https://en.cppreference.com/w/cpp/language/exceptions#Exception_safety">Exception safety</a></li>
</ul>
<h2>示例</h2>
<p><strong>示例1 - 普通的类</strong> :</p>
<pre><code class="language-cpp">#include &lt;cstdio&gt;
#include &lt;vector&gt;

struct Demo
{
    ~Demo() {printf(&quot;destructor\n&quot;);}
    Demo() {printf(&quot;constructor\n&quot;);}
    Demo(const Demo&amp;) {printf(&quot;copy\n&quot;);}
    Demo(Demo&amp;&amp;) {printf(&quot;move\n&quot;);} // 没有标注 noexcept,调用拷贝
};


int main()
{
    std::vector&lt;Demo&gt; vec;
    for (size_t i = 0; i &lt; 2; i++)
    {
        vec.emplace_back();
    }

    return 0;
}
</code></pre>
<p><strong>示例2 - 普通的模板类</strong> :</p>
<pre><code class="language-cpp">#include &lt;cstdio&gt;
#include &lt;vector&gt;

template&lt;size_t N&gt;
struct Demo
{
    ~Demo() {printf(&quot;destructor\n&quot;);}
    Demo() {printf(&quot;constructor\n&quot;);}
    Demo(const Demo&lt;N&gt;&amp;) {printf(&quot;copy\n&quot;);}
    Demo(Demo&lt;N&gt;&amp;&amp;)  {printf(&quot;move\n&quot;);} // 没有标注 noexcept,调用拷贝

    char data[N];
};


int main()
{
    std::vector&lt;Demo&lt;64&gt;&gt; vec;
    for (size_t i = 0; i &lt; 2; i++)
    {
        vec.emplace_back();
    }

    return 0;
}
</code></pre>
<p><strong>示例3 - 构造函数为模板的类</strong> :</p>
<pre><code class="language-cpp">#include &lt;cstdio&gt;
#include &lt;vector&gt;

template&lt;size_t N&gt;
struct Demo
{
    ~Demo() {printf(&quot;destructor\n&quot;);}
    Demo() {printf(&quot;constructor\n&quot;);}

    // Demo&lt;U&gt; 和 Demo&lt;N&gt; 不是同一个类型，因此这不是移动构造函数
    // 但是如果标注 noexcept，由于没有 默认移动构造函数 Demo(const Demo&lt;N&gt;&amp;&amp;)
    // std::move_if_noexcept 会通过普通的右值引用参数匹配调用此函数
    template&lt;size_t U&gt;
    explicit Demo(Demo&lt;U&gt;&amp;&amp;) {printf(&quot;move 1\n&quot;);} 
    
    // Demo&lt;U&gt; 和 Demo&lt;N&gt; 不是同一个类型，因此这不是拷贝构造函数
    // 由于有默认移动构造函数  Demo(const Demo&lt;N&gt;&amp;)
    // std::uninitialized_copy 会调用默认拷贝构造函数，而不会调用此函数
    template&lt;size_t U&gt;
    Demo(const Demo&lt;U&gt;&amp;) {printf(&quot;copy 1\n&quot;);} 
    
    // 没有显式的拷贝和移动构造函数
    // 会自动生成默认的拷贝构造函数  Demo(const Demo&lt;N&gt;&amp;);
    // std::uninitialized_copy 会调用 它进行浅拷贝
    // 如果管理指针，析构函数会产生二次释放
    
    
    // 如果删除默认拷贝构造函数：Demo(const Demo&lt;N&gt;&amp;) = delete;
    // template&lt;size_t U&gt; Demo(const Demo&lt;U&gt;&amp;); 则也不会产生该实例
    // std::uninitialized_copy 将无法在 U == T 时调用，只能在不同时调用

    char data[N];
};


int main()
{
    std::vector&lt;Demo&lt;64&gt;&gt; vec;
    for (size_t i = 0; i &lt; 2; i++)
    {
        vec.emplace_back();
    }

    return 0;
}
</code></pre>
<h2>解决方案</h2>
<p>当需要实现类似上述 <strong>示例3</strong> 的场景（存在类似拷贝构造函数或移动构造函数的模板函数）时，应当对<strong>真正的拷贝构造函数</strong>和<strong>真正的移动构造函数</strong>进行显式特例化。</p>
<pre><code class="language-c++">#include &lt;cstdio&gt;
#include &lt;vector&gt;

template&lt;size_t N&gt;
struct Demo
{
    ~Demo()
    {
        printf(&quot;destructor %p\n&quot;, this );
        delete[] data;
    }
    Demo() 
    {
        printf(&quot;constructor  %p\n&quot;, this);
        data = new float[N];
    }

    // Demo&lt;U&gt; 和 Demo&lt;N&gt; 不是同一个类型，因此这不是真正的移动构造函数
    template&lt;size_t U&gt;
    explicit Demo(Demo&lt;U&gt;&amp;&amp; src) noexcept
    {
        printf(&quot;fake move %p\n&quot;, this);
        
        if (U &gt;= N)
        {
            data = src.data;
            src.data = nullptr;
        }
        else
        {
            data = new float[N]{0};
            std::copy(data, data + U, src.data);
        }
    } 
    
    // Demo&lt;U&gt; 和 Demo&lt;N&gt; 不是同一个类型，因此这不是真正的拷贝构造函数
    template&lt;size_t U&gt;
    explicit Demo(const Demo&lt;U&gt;&amp; src) 
    {
        printf(&quot;fake copy %p\n&quot;, this);
        data = new float[N]{0};
        if (U &gt;= N)
        {
            std::copy(data, data + N, src.data);
        }
        else
        {
            std::copy(data, data + U, src.data);
        }
    }
    
    // 显式特化真正的移动构造函数
    explicit Demo(Demo&lt;N&gt;&amp;&amp; src) noexcept
    {
        printf(&quot;true move %p\n&quot;, this);
        data = src.data;
        src.data = nullptr;
    }
    
    // 显式特化真正的拷贝构造函数
    explicit Demo(const Demo&lt;N&gt;&amp; src) noexcept
    {
        printf(&quot;true copy %p\n&quot;, this);
        data = new float[N]{0};
        std::copy(data, data + N, src.data);
    }

    float* data;
};

int main()
{
    // 相同类型调用真正的移动构造函数和真正的拷贝构造函数
    {
        Demo&lt;64&gt; demo1;
        Demo&lt;64&gt; demo2{std::move_if_noexcept(demo1)};
        Demo&lt;64&gt; demo3{demo2};
    }
    
    // 不同类型调用模板函数
    {
        Demo&lt;64&gt; demo1;
        Demo&lt;32&gt; demo2{std::move_if_noexcept(demo1)};
        Demo&lt;128&gt; demo3{demo2};
    }
    return 0;
}
</code></pre>
<pre><code>==16139== Memcheck, a memory error detector
==16139== Copyright (C) 2002-2017, and GNU GPL'd, by Julian Seward et al.
==16139== Using Valgrind-3.18.1 and LibVEX; rerun with -h for copyright info
==16139== Command: ./a.out
==16139== 
constructor  0x1ffefffbb0
true move 0x1ffefffbb8
true copy 0x1ffefffbc0
destructor 0x1ffefffbc0
destructor 0x1ffefffbb8
destructor 0x1ffefffbb0
constructor  0x1ffefffbb0
fake move 0x1ffefffbb8
fake copy 0x1ffefffbc0
destructor 0x1ffefffbc0
destructor 0x1ffefffbb8
destructor 0x1ffefffbb0
==16139== 
==16139== HEAP SUMMARY:
==16139==     in use at exit: 0 bytes in 0 blocks
==16139==   total heap usage: 6 allocs, 6 frees, 75,008 bytes allocated
==16139== 
==16139== All heap blocks were freed -- no leaks are possible
==16139== 
==16139== For lists of detected and suppressed errors, rerun with: -s
==16139== ERROR SUMMARY: 0 errors from 0 contexts (suppressed: 0 from 0)
</code></pre>

        </div>
        <div class="no-print article-border-right"></div>
    </div>

    <div class="no-print article-border-bottom"></div>
</div>
    



    
        
        <div class="d-flex flex-column">
    <div class="no-print article-header d-flex px-1 text-nowrap" style="gap: 16px">
        <a class="fs-6 overflow-x-hidden text-white" href="/Phosphophyllite/articles/C%2B%2B/%E5%9C%A8%20enum%20class%20%E4%B8%AD%E4%BD%BF%E7%94%A8%20bitmask%20%E7%BB%84%E5%90%88%E7%9A%84%E6%96%B9%E6%B3%95.html"><i class="bi bi-box-arrow-up-right me-1"></i>在 enum class 中使用 bitmask 组合的方法</a>
        <div style="flex-grow: 1; flex-shrink: 1;"></div>
        <div class="fs-6"><i class="bi bi-calendar"></i><span class="time ms-1">2024-12-18 21:18:31+08:00</span></div>
    </div>

    <div class="d-flex overflow-hidden" style="max-height: 300px;">
        <div class="no-print article-border-left"></div>
        <div class="article-preview markdown-body flex-grow-1 p-2" tabindex="3">
            <h1>在 enum class 中使用 bitmask 组合的方法</h1>
<p>可以通过重载 <code>|</code> 运算符实现 bitmask 组合，例如:</p>
<pre><code class="language-c++">enum class SystemNamespaceType
{
    MOUNT   = CLONE_NEWNS,      // Mount Namespace
    UTS     = CLONE_NEWUTS,     // UNIX Time-Sharing Namespace
    IPC     = CLONE_NEWIPC,     // Inter-Process Communication Namespace
    PID     = CLONE_NEWPID,     // Process ID Namespace
    NET     = CLONE_NEWNET,     // Network Namespace
    USER    = CLONE_NEWUSER,    // User Namespace
    CGROUP  = CLONE_NEWCGROUP,  // CGroup Namespace
};

SystemNamespaceType operator | (SystemNamespaceType x, SystemNamespaceType y)
{
    return static_cast&lt;SystemNamespaceType&gt;(static_cast&lt;int&gt;(x) | static_cast&lt;int&gt;(y));
}
</code></pre>

        </div>
        <div class="no-print article-border-right"></div>
    </div>

    <div class="no-print article-border-bottom"></div>
</div>
    



<div>
    <ul class="pagination float-end">
        
        <li class="page-item disabled">
            <a class="page-link" href="#"><i class="bi bi-chevron-double-left"></i></a>
        </li>
        

        
            
            
        
            
            
        
            
            <li class="page-item active">
                <a class="page-link" href="/Phosphophyllite/categories/C%2B%2B-1.html">1</a>
            </li>
            
        
            
            
        
            
            
        

        
        <li class="page-item disabled">
            <a class="page-link" href="#"><i class="bi bi-chevron-double-right"></i></a>
        </li>
        
    </ul>
</div>


            </main>

            <aside class="no-print right-side flex-shrink-0 d-flex flex-column">
            

<div class="card">
    <img src="https://github-readme-stats.vercel.app/api?username=hubenchang0515&theme=transparent&hide_border=true&show_icons=true&card_width=400"/>
</div>

<div class="card">
    <img src="https://github-readme-stats.vercel.app/api/top-langs/?username=hubenchang0515&layout=compact&theme=transparent&hide_border=true&card_width=400&langs_count=32&size_weight=0.1&count_weight=0.9&hide=cmake%2Cqmake%2Cmakefile%2Cshell%2Cobjective-c"/>
</div>

<div class="card">
    <div class="card-body">
        <h4 class="card-title">导航</h4>
        <h6 class="card-subtitle mb-2 text-muted">Navigation</h6>
        <div class="d-flex flex-wrap" style="gap: 8px;">
            
            <a class="link-info" href="https://hubenchang0515.github.io/" target="_blank"><i class="bi bi-link-45deg"></i> 主页</a>
            
            <a class="link-info" href="https://hubenchang0515.github.io/primers/" target="_blank"><i class="bi bi-link-45deg"></i> Primers 编程教程</a>
            
            <a class="link-info" href="https://hubenchang0515.github.io/QtTheme/" target="_blank"><i class="bi bi-link-45deg"></i> QtTheme</a>
            
            <a class="link-info" href="https://hubenchang0515.github.io/shift/" target="_blank"><i class="bi bi-link-45deg"></i> Shift 在线编程</a>
            
            <a class="link-info" href="https://hubenchang0515.github.io/moe-tools/" target="_blank"><i class="bi bi-link-45deg"></i> 萌萌工具箱</a>
            
            <a class="link-info" href="https://hubenchang0515.github.io/friends/" target="_blank"><i class="bi bi-link-45deg"></i> 友情链接</a>
            
        </div>
    </div>
</div>

<div class="card sticky">
    <div class="card-body">
        <h4 class="card-title">最近文章</h4>
        <h6 class="card-subtitle mb-2 text-muted">Recent Articles</h6>
        <ul>
            
            <li>
                <a class="link-info" href="/Phosphophyllite/articles/React/MUI%20%E9%9B%86%E6%88%90%20nextjs.html">MUI 集成 nextjs</a>
            </li>
            
            <li>
                <a class="link-info" href="/Phosphophyllite/articles/MySQL/MySQL%20%E5%85%A8%E6%96%87%E7%B4%A2%E5%BC%95.html">MySQL 全文索引</a>
            </li>
            
            <li>
                <a class="link-info" href="/Phosphophyllite/articles/%E8%B5%84%E6%BA%90%E5%88%86%E4%BA%AB/%E5%9C%A8%20eu.org%20%E6%B3%A8%E5%86%8C%E5%85%8D%E8%B4%B9%E5%9F%9F%E5%90%8D.html">在 eu.org 注册免费域名</a>
            </li>
            
            <li>
                <a class="link-info" href="/Phosphophyllite/articles/MySQL/MySQL%20%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9F%BA%E7%A1%80%E5%91%BD%E4%BB%A4.html">MySQL 数据库基础命令</a>
            </li>
            
            <li>
                <a class="link-info" href="/Phosphophyllite/articles/MySQL/MySQL%20%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%9D%E5%A7%8B%E5%8C%96.html">MySQL 数据库初始化</a>
            </li>
            
            <li>
                <a class="link-info" href="/Phosphophyllite/articles/Minecraft/%E4%BD%BF%E7%94%A8%20Tan90-Proxy%20%E4%BB%A3%E7%90%86%20Minecraft%20%E6%9C%8D%E5%8A%A1%E5%99%A8.html">使用 Tan90-Proxy 代理 Minecraft 服务器</a>
            </li>
            
            <li>
                <a class="link-info" href="/Phosphophyllite/articles/Minecraft/Minecraft%20%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8B%E8%BD%BD%E9%A1%B5%E5%9C%B0%E5%9D%80.html">Minecraft 服务器下载页地址</a>
            </li>
            
            <li>
                <a class="link-info" href="/Phosphophyllite/articles/nginx/nginx%20%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E4%B8%8E%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE.html">nginx 常用命令与基础配置</a>
            </li>
            
            <li>
                <a class="link-info" href="/Phosphophyllite/articles/Linux%20%E5%91%BD%E4%BB%A4%E4%B8%8E%E9%85%8D%E7%BD%AE/%E5%88%B6%E4%BD%9C%20deb%20%E5%8C%85.html">制作 deb 包</a>
            </li>
            
            <li>
                <a class="link-info" href="/Phosphophyllite/articles/Windows%20%E5%91%BD%E4%BB%A4%E4%B8%8E%E9%85%8D%E7%BD%AE/Windows%20%E6%B3%A8%E5%86%8C%E8%A1%A8%E4%B8%AD%E6%B7%BB%E5%8A%A0%E8%87%AA%E5%B7%B1%E7%9A%84%E7%A8%8B%E5%BA%8F.html">Windows 注册表中添加自己的程序</a>
            </li>
            
        </ul>
    </div>
</div>


            </aside>
        </div>

        <footer class="no-print">
            

<div class="card" style="border-radius: 0;">
    <p class="github-brief card-text" style="margin: auto;">
        Powered by <i class="bi bi-arrow-through-heart-fill"></i> <a class="card-link link-success" href="https://github.com/hubenchang0515/Phosphophyllite" target="_blank">Phosphophyllite</a>
    </p>
</div>


        </footer>

        

<script>
    fetchUserInfo("hubenchang0515");
    scanTime();
</script>


    </body>
</html>