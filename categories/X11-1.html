
<!DOCTYPE html>
<html lang="zh">
    <head>

        
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="icon" type="image/svg+xml" href="/Phosphophyllite/favicon.svg">
        
        

        
        <title>PlanC 的博客 - X11</title>
        <meta name="description" content="PlanC 的博客 - X11 分类 - 第 1 页">
        

        
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet" >
        <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/nord.min.css" rel="stylesheet">
        <link href="/Phosphophyllite/css/normalize.css" rel="stylesheet">
        <link href="/Phosphophyllite/css/bootstrap-quartz-theme.min.css" rel="stylesheet">
        <link href="/Phosphophyllite/css/github-markdown.css" rel="stylesheet">
        <link href="/Phosphophyllite/css/custom.css" rel="stylesheet">
        <link href="/Phosphophyllite/css/custom-dark.css" rel="stylesheet">
        
        
        
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
        <script src="/Phosphophyllite/js/custom.js"></script>
        

        <!-- Google tag (gtag.js) -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-HEWPX7E6EV"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', 'G-HEWPX7E6EV');
        </script>

        <script>
            
            document.oncopy = makeOnCopy("PlanC");
            
        </script>
    </head>

    <body class="d-flex flex-column">
        

<nav class="navbar navbar-expand-lg card no-print" data-bs-theme="dark" style="border-radius: 0;">
    <div class="container-fluid">
        <span class="navbar-brand">PlanC 的博客</span>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarColor01" aria-controls="navbarColor01" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarColor01">
            <ul class="navbar-nav me-auto">
                <li class="nav-item">
                    <a class="nav-link active" href="/Phosphophyllite/">首页</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="https://github.com/hubenchang0515" target="_blank">GitHub</a>
                </li>
            </ul>
            <form id='search-form' class="d-flex">
                <input id="search-input" name="q" class="form-control text-info me-sm-2" type="search" placeholder="Search" autocomplete="off">
            </form>
            <script>
                makeSearch("https://xplanc.org/Phosphophyllite", 'search-form', 'search-input')
            </script>
        </div>
    </div>
</nav>



        <div class="content d-flex flex-grow-1 m-2">
            <aside class="no-print left-side flex-shrink-0 d-flex flex-column"> 
            

<div class="card">
    <div class="card-body">
        <div style="margin: auto;">
            <img class="github-avatar" src="https://github.com/hubenchang0515.png"/>
            <h4 class="github-name card-title">PlanC</h4>
            <h6 class="github-username card-subtitle mb-2 text-muted">hubenchang0515</h6>
            <p class="github-brief card-text"></p>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <h4 class="card-title">文章分类</h4>
        <h6 class="card-subtitle mb-2 text-muted">Categories</h6>

        <div style="width: 100%;display: flex; flex-wrap: wrap; gap: 4px;">
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/Linux%20%E5%91%BD%E4%BB%A4%E4%B8%8E%E9%85%8D%E7%BD%AE-1.html">
                <span>
                    Linux 命令与配置
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    18
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/FreeRTOS-1.html">
                <span>
                    FreeRTOS
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    10
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/Qt-1.html">
                <span>
                    Qt
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    10
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/Linux%20API-1.html">
                <span>
                    Linux API
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    9
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/%E4%BB%A3%E7%90%86%E4%B8%8E%E9%95%9C%E5%83%8F%E6%BA%90%E9%85%8D%E7%BD%AE-1.html">
                <span>
                    代理与镜像源配置
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    9
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/%E9%BB%98%E8%AE%A4%E5%88%86%E7%B1%BB-1.html">
                <span>
                    默认分类
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    8
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/X11-1.html">
                <span>
                    X11
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    5
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/CUDA-1.html">
                <span>
                    CUDA
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    4
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/C%20%E8%AF%AD%E8%A8%80-1.html">
                <span>
                    C 语言
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    3
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/C%2B%2B-1.html">
                <span>
                    C++
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    3
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/CMake-1.html">
                <span>
                    CMake
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    3
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/MySQL-1.html">
                <span>
                    MySQL
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    3
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/Python-1.html">
                <span>
                    Python
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    3
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/Windows%20API-1.html">
                <span>
                    Windows API
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    3
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/%E6%B1%87%E7%BC%96-1.html">
                <span>
                    汇编
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    3
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/Docker-1.html">
                <span>
                    Docker
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    2
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/Minecraft-1.html">
                <span>
                    Minecraft
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    2
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/FreeType-1.html">
                <span>
                    FreeType
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    1
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/GitHub-1.html">
                <span>
                    GitHub
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    1
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/GitLab-1.html">
                <span>
                    GitLab
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    1
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/Golang-1.html">
                <span>
                    Golang
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    1
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/Kafka-1.html">
                <span>
                    Kafka
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    1
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/OpenCL-1.html">
                <span>
                    OpenCL
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    1
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/OpenGL-1.html">
                <span>
                    OpenGL
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    1
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/React-1.html">
                <span>
                    React
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    1
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/Windows%20%E5%91%BD%E4%BB%A4%E4%B8%8E%E9%85%8D%E7%BD%AE-1.html">
                <span>
                    Windows 命令与配置
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    1
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/nginx-1.html">
                <span>
                    nginx
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    1
                </span>
            </a>
            
            <a class="category-link link-underline link-underline-opacity-0" href="/Phosphophyllite/categories/%E8%B5%84%E6%BA%90%E5%88%86%E4%BA%AB-1.html">
                <span>
                    资源分享
                </span>
                <span style="flex: 1;"></span>
                <span class="badge" style="background-color: #ec407a;">
                    1
                </span>
            </a>
            
        </div>
    </div>
</div>


            </aside>

            <main class="main-content flex-grow-1 flex-shrink-1 d-flex flex-column overflow-x-hidden">
                





    
        
        <div class="d-flex flex-column">
    <div class="no-print article-header d-flex px-1 text-nowrap" style="gap: 16px">
        <a class="fs-6 overflow-x-hidden text-white" href="/Phosphophyllite/articles/X11/X11%20%E5%89%AA%E5%88%87%E6%9D%BF.html"><i class="bi bi-box-arrow-up-right me-1"></i>X11 剪切板</a>
        <div style="flex-grow: 1; flex-shrink: 1;"></div>
        <div class="fs-6"><i class="bi bi-calendar"></i><span class="time ms-1">2024-12-18 21:18:31+08:00</span></div>
    </div>

    <div class="d-flex overflow-hidden" style="max-height: 300px;">
        <div class="no-print article-border-left"></div>
        <div class="article-preview markdown-body flex-grow-1 p-2" tabindex="1">
            <h1>X11 剪切板</h1>
<p>参考:</p>
<ul>
<li><a href="https://www.uninformativ.de/blog/postings/2017-04-02/0/POSTING-en.html">X11: How does “the” clipboard work?</a></li>
<li><a href="https://tronche.com/gui/x/icccm/sec-2.html#s-2">Peer-to-Peer Communication by Means of Selections</a></li>
</ul>
<p>首先在 X11 上剪切板被称作 <code>Selections</code>，系统上可以有任意多个 <code>Selections</code>，并且有三个预定义的标准 <code>Selections</code>:</p>
<ul>
<li><code>primary</code> - 当前选中的文本，例如终端上点击鼠标中键可以立即粘贴选中的文本</li>
<li><code>secondary</code> - 没有被使用</li>
<li><code>clipboard</code> - 通常意义上的剪切板，不同进程间交换数据时使用它</li>
</ul>
<p>只有 <code>Selection</code> 的拥有者（owner）可以修改它，其它进程只能读取。owner 需要负责保存 <code>Selection</code> 的内容，并在其它进程请求读取的时候返回给对方。</p>
<p>当用户使用 <code>Ctrl + C</code> 进行复制时，当前应用就会申请成为 <code>clipboard</code> 的拥有者，之前的拥有者需要让出。</p>
<p>如果应用程序只希望在内部复制粘贴数据，不希望与其它进程交换信息，可以创建一个任意命名的属于自己的剪切板。</p>
<p>以下代码可以查看 <code>clipboard</code> 的当前 owner:</p>
<pre><code class="language-c">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;xcb/xcb.h&gt;

int main(void)
{
    // 建立连接
    xcb_connection_t* conn = xcb_connect(NULL, NULL);

    // 获取 screen
    const xcb_setup_t* setup = xcb_get_setup(conn);
    xcb_screen_iterator_t iter = xcb_setup_roots_iterator(setup);
    xcb_screen_t* screen = iter.data;

    // 获取 root 窗口
    xcb_window_t root = screen-&gt;root;

    // 创建 ATOM
    xcb_atom_t nameAtom;
    {
        const char* name = &quot;PRIMARY&quot;;
        xcb_intern_atom_cookie_t cookie = xcb_intern_atom(conn, 0, strlen(name), name);
        xcb_intern_atom_reply_t* reply = xcb_intern_atom_reply(conn, cookie, NULL);
        nameAtom = reply-&gt;atom;
        free(reply);
    }
    
    // 读取剪切板的 owner
    xcb_window_t owner;
    {
        xcb_get_selection_owner_cookie_t cookie =  xcb_get_selection_owner(conn, nameAtom);
        xcb_get_selection_owner_reply_t* reply = xcb_get_selection_owner_reply(conn, cookie, NULL);
        owner = reply-&gt;owner;
        free(reply);
    }

    // 读取窗口名称
    #define BUFFER_SIZE 64
    char name[BUFFER_SIZE] = {0};
    {
        xcb_get_property_cookie_t cookie = xcb_get_property(conn, 0, owner, XCB_ATOM_WM_NAME, XCB_ATOM_STRING, 0, BUFFER_SIZE/4);
        xcb_get_property_reply_t* reply = xcb_get_property_reply(conn, cookie, NULL);
        int len = xcb_get_property_value_length(reply);
        len = len &gt; 64 ? 64 : len;
        strncpy(name, xcb_get_property_value(reply), len);
        free(reply);
    }
    #undef BUFFER_SIZE

    // 打印
    printf(&quot;Owner ID: 0x%x\n&quot;, owner);
    printf(&quot;Owner Name: %s\n&quot;, name);
}
</code></pre>
<p>以下代码可以将自己设为 <code>clipboard</code> 的 owner，并将所有的粘贴内容替换为当前的时间字符串:</p>
<pre><code class="language-c">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;time.h&gt;
#include &lt;xcb/xcb.h&gt;
#include &lt;xcb/xfixes.h&gt;

int main(void)
{
    // 建立连接
    xcb_connection_t* conn = xcb_connect(NULL, NULL);

    // 获取 screen
    const xcb_setup_t* setup = xcb_get_setup(conn);
    xcb_screen_iterator_t iter = xcb_setup_roots_iterator(setup);
    xcb_screen_t* screen = iter.data;

    // 获取 root 窗口
    xcb_window_t root = screen-&gt;root;

    // 创建一个窗口
    xcb_window_t window = xcb_generate_id(conn);
    {
        uint32_t mask = XCB_CW_BACK_PIXEL | XCB_CW_EVENT_MASK;
        uint32_t values[2];
        values[0] = screen-&gt;white_pixel;
        values[1] = XCB_EVENT_MASK_KEY_PRESS | XCB_EVENT_MASK_KEY_RELEASE;
        xcb_create_window(conn, XCB_COPY_FROM_PARENT, window, root, 0, 0, 300, 200, 50, XCB_WINDOW_CLASS_INPUT_OUTPUT, screen-&gt;root_visual, mask, values);
        xcb_map_window(conn, window);
    }

    // 创建 ATOM
    xcb_atom_t nameAtom;
    {
        const char* name = &quot;CLIPBOARD&quot;;
        xcb_intern_atom_cookie_t cookie = xcb_intern_atom(conn, 0, strlen(name), name);
        xcb_intern_atom_reply_t* reply = xcb_intern_atom_reply(conn, cookie, NULL);
        nameAtom = reply-&gt;atom;
        free(reply);
    }

    // 创建 ATOM
    xcb_atom_t utf8StrAtom;
    {
        const char* name = &quot;UTF8_STRING&quot;;
        xcb_intern_atom_cookie_t cookie = xcb_intern_atom(conn, 0, strlen(name), name);
        xcb_intern_atom_reply_t* reply = xcb_intern_atom_reply(conn, cookie, NULL);
        utf8StrAtom = reply-&gt;atom;
        free(reply);
    }
    
    // 创建一个 selection 并将自己设为的 owner
    xcb_set_selection_owner(conn, window, nameAtom, XCB_TIME_CURRENT_TIME);

    // 检查是否成功
    xcb_window_t owner;
    {
        xcb_get_selection_owner_cookie_t cookie = xcb_get_selection_owner(conn, nameAtom);
        xcb_get_selection_owner_reply_t* reply = xcb_get_selection_owner_reply(conn, cookie, NULL);
        owner = reply-&gt;owner;
    }

    if (owner != window)
    {
        printf(&quot;failed to set selection owner, owner id is 0x%x\n&quot;, owner);
        return 1;
    }

    // 读取事件
    xcb_generic_event_t* event;
    while ((event = xcb_wait_for_event(conn)))
    {
        printf(&quot;event type: %d\n&quot;, event-&gt;response_type);
        // 其它进程请求读取这个 selection
        if(event-&gt;response_type == XCB_SELECTION_REQUEST)
        {
            xcb_selection_request_event_t* request = (xcb_selection_request_event_t*)event;

            xcb_selection_notify_event_t response; // 通知对端的事件
            response.response_type =XCB_SELECTION_NOTIFY;
            response.requestor = request-&gt;requestor;
            response.selection = request-&gt;selection;
            response.target = request-&gt;target;
            response.property = request-&gt;property;
            response.time = request-&gt;time;

            // 只处理 UTF8_STRING
            if (request-&gt;property == XCB_ATOM_NONE || request-&gt;target != utf8StrAtom)
            {
                response.property = XCB_ATOM_NONE;
            }
            else
            {
                // 返回当前时间
                time_t nowTime = time(NULL);
                char* nowStr = ctime(&amp;nowTime);
                xcb_change_property(conn, XCB_PROP_MODE_REPLACE, request-&gt;requestor, request-&gt;property, request-&gt;target, 8, strlen(nowStr), nowStr);
            }
            
            xcb_send_event(conn, 1, request-&gt;requestor, 0, (char*)&amp;response);
            xcb_flush(conn);

            printf(&quot;done\n&quot;);
        }
    }

    xcb_disconnect(conn);
    return 0;
}
</code></pre>
<p>当一个应用进行复制时，实际上是将自己设为了 <code>clipboard</code> 的 owner，并在其它应用请求粘贴时返回数据。
为了避免复制的数据丢失，成为 owner 时要将之前的数据都保存过来。</p>
<p>如果 owner 退出，selection 会丢失。为了避免这一情况，需要一个 clipboard manager 进程作为 <code>clipboard</code> 的 owner。
当其它进程进行复制操作成为 owner 时，clipboard manager应当进行以下操作:</p>
<ol>
<li>向新的 owner 询问所有数据，并将这些数据保存起来</li>
<li>重新将自己声明为 owner</li>
</ol>

        </div>
        <div class="no-print article-border-right"></div>
    </div>

    <div class="no-print article-border-bottom"></div>
</div>
    



    
        
        <div class="d-flex flex-column">
    <div class="no-print article-header d-flex px-1 text-nowrap" style="gap: 16px">
        <a class="fs-6 overflow-x-hidden text-white" href="/Phosphophyllite/articles/X11/xcb%20%E6%88%AA%E5%9B%BE.html"><i class="bi bi-box-arrow-up-right me-1"></i>xcb 截图</a>
        <div style="flex-grow: 1; flex-shrink: 1;"></div>
        <div class="fs-6"><i class="bi bi-calendar"></i><span class="time ms-1">2024-12-18 21:18:31+08:00</span></div>
    </div>

    <div class="d-flex overflow-hidden" style="max-height: 300px;">
        <div class="no-print article-border-left"></div>
        <div class="article-preview markdown-body flex-grow-1 p-2" tabindex="2">
            <h1>xcb 截图</h1>
<p>通过 <code>xcb_get_image</code> 可以进行截图:</p>
<pre><code class="language-C">xcb_get_image_cookie_t
xcb_get_image (xcb_connection_t *c,               // X连接
               uint8_t           format,          // 格式 
               xcb_drawable_t    drawable,        // 要截图的目标，例如窗口，截全屏则为 root 窗口
               int16_t           x,               // 截图的起点 x 坐标
               int16_t           y,               // 截图的起点 y 坐标
               uint16_t          width,           // 截图的宽度
               uint16_t          height,          // 截图的高度
               uint32_t          plane_mask);     // 色彩通道掩码，例如 0x00ff0000 表示只保留红色通道（小端）
</code></pre>
<pre><code class="language-c">#include &lt;xcb/xcb.h&gt;
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;

// 将 BGRX 转换为 RGB
static uint8_t* BGRX2RGB(const uint8_t* in, int16_t width, int32_t height)
{
    uint8_t* out = malloc(width * height *3);
    for (int16_t y = 0; y &lt; height; y++)
    {
        for(int16_t x = 0; x &lt; width; x++)
        {
            out[(y*width+x)*3] = in[(y*width+x)*4 + 2];
            out[(y*width+x)*3 + 1] = in[(y*width+x)*4 + 1];
            out[(y*width+x)*3 + 2] = in[(y*width+x)*4];
        }
    }
    return out;
}

int main()
{
    // 建立连接
    xcb_connection_t* conn = xcb_connect(NULL, NULL);

    // 获取 screen
    const xcb_setup_t* setup = xcb_get_setup(conn);
    xcb_screen_iterator_t iter = xcb_setup_roots_iterator(setup);
    xcb_screen_t* screen = iter.data;

    // 获取 root 窗口
    xcb_window_t root = screen-&gt;root;

    // 获取屏幕的宽高
    int16_t width = 0;
    int16_t height = 0;
    {
        xcb_get_geometry_cookie_t cookie = xcb_get_geometry(conn, root);
        xcb_get_geometry_reply_t* reply = xcb_get_geometry_reply(conn, cookie, NULL);
        width = reply-&gt;width;
        height = reply-&gt;height;
        free(reply);
    }

    // 读取屏幕图像
    uint8_t* data = NULL;
    {
        // XCB_IMAGE_FORMAT_Z_PIXMAP 是 BGRX 格式
        // 其中 plane_mask 用于过滤不需要的通道,例如 0x00ff0000 表示只保留红色通道（注意小端）
        xcb_get_image_cookie_t cookie = xcb_get_image(conn, XCB_IMAGE_FORMAT_Z_PIXMAP, root, 0, 0, width, height, UINT32_MAX);
        xcb_get_image_reply_t* reply = xcb_get_image_reply(conn, cookie, NULL);
        data = BGRX2RGB(xcb_get_image_data(reply), width, height);
        free(reply);
    }

    FILE* fp = fopen(&quot;out.ppm&quot;, &quot;wb&quot;);
    fprintf(fp, &quot;P6\n&quot;);
    fprintf(fp, &quot;%d %d 255\n&quot;, width, height);
    fwrite(data, width*height*3, 1, fp);
    fclose(fp);

    free(data);
    xcb_disconnect(conn);

    return EXIT_SUCCESS;
}
</code></pre>

        </div>
        <div class="no-print article-border-right"></div>
    </div>

    <div class="no-print article-border-bottom"></div>
</div>
    



    
        
        <div class="d-flex flex-column">
    <div class="no-print article-header d-flex px-1 text-nowrap" style="gap: 16px">
        <a class="fs-6 overflow-x-hidden text-white" href="/Phosphophyllite/articles/X11/xcb%20%E8%8E%B7%E5%8F%96%E4%BA%8B%E4%BB%B6.html"><i class="bi bi-box-arrow-up-right me-1"></i>xcb 获取事件</a>
        <div style="flex-grow: 1; flex-shrink: 1;"></div>
        <div class="fs-6"><i class="bi bi-calendar"></i><span class="time ms-1">2024-12-18 21:18:31+08:00</span></div>
    </div>

    <div class="d-flex overflow-hidden" style="max-height: 300px;">
        <div class="no-print article-border-left"></div>
        <div class="article-preview markdown-body flex-grow-1 p-2" tabindex="3">
            <h1>xcb 获取事件</h1>
<h2>获取窗口事件</h2>
<pre><code class="language-c">// 获取窗口事件
#include &lt;stdio.h&gt;
#include &lt;xcb/xcb.h&gt;

int main()
{
    // 连接到X11 Server
    xcb_connection_t* conn = xcb_connect(NULL, NULL);

    // 获取screen
    const xcb_setup_t* setup = xcb_get_setup(conn);
    xcb_screen_iterator_t iter = xcb_setup_roots_iterator(setup);
    xcb_screen_t* screen = iter.data;

    // 创建窗口
    xcb_window_t window = xcb_generate_id(conn);
    uint32_t mask = XCB_CW_BACK_PIXEL | XCB_CW_EVENT_MASK;
    uint32_t values[2];
    values[0] = screen-&gt;white_pixel;
    values[1] = XCB_EVENT_MASK_KEY_PRESS | XCB_EVENT_MASK_KEY_RELEASE;

    xcb_create_window(conn, XCB_COPY_FROM_PARENT, window, screen-&gt;root, 
                        0, 0, 500, 500, 10, XCB_WINDOW_CLASS_INPUT_OUTPUT, 
                        screen-&gt;root_visual, mask, values);

    xcb_map_window(conn, window);
    xcb_flush(conn);

    // 读取事件
    xcb_generic_event_t* event;
    while((event = xcb_wait_for_event(conn))) {
        if(event-&gt;response_type == XCB_KEY_PRESS)
        {
            xcb_key_press_event_t *press = (xcb_key_press_event_t*)event;
            printf(&quot;press %d\n&quot;, press-&gt;detail);
        }
        
        if(event-&gt;response_type == XCB_KEY_RELEASE)
        {
            xcb_key_press_event_t *press = (xcb_key_press_event_t*)event;
            printf(&quot;release %d\n&quot;, press-&gt;detail);
        }
    }

    xcb_disconnect(conn);
}
</code></pre>
<h2>获取全局事件</h2>
<pre><code class="language-c">// 获取全局事件
#include &lt;stdio.h&gt;
#include &lt;xcb/xcb.h&gt;


#define	ModMaskAlt          XCB_MOD_MASK_1
#define ModMaskNumLock      XCB_MOD_MASK_2 
#define ModMaskSuper        XCB_MOD_MASK_4 
#define ModMaskModeSwitch   XCB_MOD_MASK_5
#define ModMaskShift        XCB_MOD_MASK_SHIFT
#define ModMaskCapsLock     XCB_MOD_MASK_LOCK
#define ModMaskControl      XCB_MOD_MASK_CONTROL

int main()
{
    // 连接到X11 Server
    xcb_connection_t* conn = xcb_connect(NULL, NULL);

    // 获取screen
    const xcb_setup_t* setup = xcb_get_setup(conn);
    xcb_screen_iterator_t iter = xcb_setup_roots_iterator(setup);
    xcb_screen_t* screen = iter.data;

    // 捕获快捷键
    xcb_grab_key(conn, 1, screen-&gt;root,
                ModMaskControl, 46, // Ctrl + L
                XCB_GRAB_MODE_ASYNC, XCB_GRAB_MODE_ASYNC);
    xcb_grab_key(conn, 1, screen-&gt;root,
                ModMaskControl | ModMaskCapsLock, 46, // Ctrl + L with CapsLock
                XCB_GRAB_MODE_ASYNC, XCB_GRAB_MODE_ASYNC);
    xcb_grab_key(conn, 1, screen-&gt;root,
                ModMaskControl | ModMaskNumLock, 46, // Ctrl + L with NumLock
                XCB_GRAB_MODE_ASYNC, XCB_GRAB_MODE_ASYNC);
    xcb_grab_key(conn, 1, screen-&gt;root,
                ModMaskControl | ModMaskCapsLock | ModMaskNumLock, 46, // Ctrl + L with CapsLock and NumLock
                XCB_GRAB_MODE_ASYNC, XCB_GRAB_MODE_ASYNC);
    xcb_flush(conn);

    // 读取事件
    xcb_generic_event_t* event;
    while((event = xcb_wait_for_event(conn))) {
        if(event-&gt;response_type == XCB_KEY_PRESS)
        {
            xcb_key_press_event_t *press = (xcb_key_press_event_t*)event;
            printf(&quot;press %d\n&quot;, press-&gt;detail);
        }

        if(event-&gt;response_type == XCB_KEY_RELEASE)
        {
            xcb_key_press_event_t *press = (xcb_key_press_event_t*)event;
            printf(&quot;release %d\n&quot;, press-&gt;detail);
        }
    }

    xcb_disconnect(conn);
}
</code></pre>

        </div>
        <div class="no-print article-border-right"></div>
    </div>

    <div class="no-print article-border-bottom"></div>
</div>
    



    
        
        <div class="d-flex flex-column">
    <div class="no-print article-header d-flex px-1 text-nowrap" style="gap: 16px">
        <a class="fs-6 overflow-x-hidden text-white" href="/Phosphophyllite/articles/X11/xcb%20%E8%8E%B7%E5%8F%96%E9%BC%A0%E6%A0%87%E6%8C%87%E9%92%88%E7%9A%84%E5%9D%90%E6%A0%87.html"><i class="bi bi-box-arrow-up-right me-1"></i>xcb 获取鼠标指针的坐标</a>
        <div style="flex-grow: 1; flex-shrink: 1;"></div>
        <div class="fs-6"><i class="bi bi-calendar"></i><span class="time ms-1">2024-12-18 21:18:31+08:00</span></div>
    </div>

    <div class="d-flex overflow-hidden" style="max-height: 300px;">
        <div class="no-print article-border-left"></div>
        <div class="article-preview markdown-body flex-grow-1 p-2" tabindex="4">
            <h1>xcb 获取鼠标指针的坐标</h1>
<pre><code class="language-cpp">typedef struct xcb_query_pointer_reply_t {
    uint8_t      response_type;
    uint8_t      same_screen;
    uint16_t     sequence;
    uint32_t     length;
    xcb_window_t root;
    xcb_window_t child;
    int16_t      root_x;
    int16_t      root_y;
    int16_t      win_x;
    int16_t      win_y;
    uint16_t     mask;
    uint8_t      pad0[2];
} xcb_query_pointer_reply_t;

xcb_query_pointer_cookie_t xcb_query_pointer(xcb_connection_t *conn, xcb_window_t window);
xcb_query_pointer_reply_t *xcb_query_pointer_reply(xcb_connection_t *conn, xcb_query_pointer_cookie_t cookie, xcb_generic_error_t **e);
</code></pre>
<pre><code class="language-cpp">#include &lt;stdio.h&gt;
#include &lt;xcb/xcb.h&gt;

int main()
{
    // 连接到X11 Server
    xcb_connection_t* conn = xcb_connect(NULL, NULL);

    // 获取screen
    const xcb_setup_t* setup = xcb_get_setup(conn);
    xcb_screen_iterator_t iter = xcb_setup_roots_iterator(setup);
    xcb_screen_t* screen = iter.data;

    // 获取鼠标指针的坐标
    xcb_query_pointer_cookie_t cookie = xcb_query_pointer(conn, screen-&gt;root);
    xcb_query_pointer_reply_t* reply = xcb_query_pointer_reply(conn, cookie, NULL);
    printf(&quot;%d %d\n&quot;, reply-&gt;root_x, reply-&gt;root_y);
    free(reply);
    
    xcb_disconnect(conn);
    return 0;
}
</code></pre>

        </div>
        <div class="no-print article-border-right"></div>
    </div>

    <div class="no-print article-border-bottom"></div>
</div>
    



    
        
        <div class="d-flex flex-column">
    <div class="no-print article-header d-flex px-1 text-nowrap" style="gap: 16px">
        <a class="fs-6 overflow-x-hidden text-white" href="/Phosphophyllite/articles/X11/%E6%98%BE%E7%A4%BA%20X11%20%E7%9A%84%E7%A9%BA%E9%97%B2%E6%97%B6%E9%97%B4.html"><i class="bi bi-box-arrow-up-right me-1"></i>显示 X11 的空闲时间</a>
        <div style="flex-grow: 1; flex-shrink: 1;"></div>
        <div class="fs-6"><i class="bi bi-calendar"></i><span class="time ms-1">2024-12-18 21:18:31+08:00</span></div>
    </div>

    <div class="d-flex overflow-hidden" style="max-height: 300px;">
        <div class="no-print article-border-left"></div>
        <div class="article-preview markdown-body flex-grow-1 p-2" tabindex="5">
            <h1>显示 X11 的空闲时间</h1>
<pre><code class="language-c">// gcc main.c -lX11 -lXss
#include &lt;stdio.h&gt;
#include &lt;X11/extensions/scrnsaver.h&gt;

int main(void) 
{
    Display* dpy = XOpenDisplay(NULL);
    if (!dpy) 
        return 1;

    XScreenSaverInfo* info = XScreenSaverAllocInfo();
    while(1)
    {
        XScreenSaverQueryInfo(dpy, DefaultRootWindow(dpy), info);
        printf(&quot;%u\n&quot;, info-&gt;idle);
    }

    return 0;
}
</code></pre>

        </div>
        <div class="no-print article-border-right"></div>
    </div>

    <div class="no-print article-border-bottom"></div>
</div>
    



<div>
    <ul class="pagination float-end">
        
        <li class="page-item disabled">
            <a class="page-link" href="#"><i class="bi bi-chevron-double-left"></i></a>
        </li>
        

        
            
            
        
            
            
        
            
            <li class="page-item active">
                <a class="page-link" href="/Phosphophyllite/categories/X11-1.html">1</a>
            </li>
            
        
            
            
        
            
            
        

        
        <li class="page-item disabled">
            <a class="page-link" href="#"><i class="bi bi-chevron-double-right"></i></a>
        </li>
        
    </ul>
</div>


            </main>

            <aside class="no-print right-side flex-shrink-0 d-flex flex-column">
            

<div class="card">
    <img src="https://github-readme-stats.vercel.app/api?username=hubenchang0515&theme=transparent&hide_border=true&show_icons=true&card_width=400"/>
</div>

<div class="card">
    <img src="https://github-readme-stats.vercel.app/api/top-langs/?username=hubenchang0515&layout=compact&theme=transparent&hide_border=true&card_width=400&langs_count=32&size_weight=0.1&count_weight=0.9&hide=cmake%2Cqmake%2Cmakefile%2Cshell%2Cobjective-c"/>
</div>

<div class="card">
    <div class="card-body">
        <h4 class="card-title">导航</h4>
        <h6 class="card-subtitle mb-2 text-muted">Navigation</h6>
        <div class="d-flex flex-wrap" style="gap: 8px;">
            
            <a class="link-info" href="https://hubenchang0515.github.io/" target="_blank"><i class="bi bi-link-45deg"></i> 主页</a>
            
            <a class="link-info" href="https://hubenchang0515.github.io/primers/" target="_blank"><i class="bi bi-link-45deg"></i> Primers 编程教程</a>
            
            <a class="link-info" href="https://hubenchang0515.github.io/QtTheme/" target="_blank"><i class="bi bi-link-45deg"></i> QtTheme</a>
            
            <a class="link-info" href="https://hubenchang0515.github.io/shift/" target="_blank"><i class="bi bi-link-45deg"></i> Shift 在线编程</a>
            
            <a class="link-info" href="https://hubenchang0515.github.io/moe-tools/" target="_blank"><i class="bi bi-link-45deg"></i> 萌萌工具箱</a>
            
            <a class="link-info" href="https://hubenchang0515.github.io/friends/" target="_blank"><i class="bi bi-link-45deg"></i> 友情链接</a>
            
        </div>
    </div>
</div>

<div class="card sticky">
    <div class="card-body">
        <h4 class="card-title">最近文章</h4>
        <h6 class="card-subtitle mb-2 text-muted">Recent Articles</h6>
        <ul>
            
            <li>
                <a class="link-info" href="/Phosphophyllite/articles/React/MUI%20%E9%9B%86%E6%88%90%20nextjs.html">MUI 集成 nextjs</a>
            </li>
            
            <li>
                <a class="link-info" href="/Phosphophyllite/articles/MySQL/MySQL%20%E5%85%A8%E6%96%87%E7%B4%A2%E5%BC%95.html">MySQL 全文索引</a>
            </li>
            
            <li>
                <a class="link-info" href="/Phosphophyllite/articles/%E8%B5%84%E6%BA%90%E5%88%86%E4%BA%AB/%E5%9C%A8%20eu.org%20%E6%B3%A8%E5%86%8C%E5%85%8D%E8%B4%B9%E5%9F%9F%E5%90%8D.html">在 eu.org 注册免费域名</a>
            </li>
            
            <li>
                <a class="link-info" href="/Phosphophyllite/articles/MySQL/MySQL%20%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9F%BA%E7%A1%80%E5%91%BD%E4%BB%A4.html">MySQL 数据库基础命令</a>
            </li>
            
            <li>
                <a class="link-info" href="/Phosphophyllite/articles/MySQL/MySQL%20%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%9D%E5%A7%8B%E5%8C%96.html">MySQL 数据库初始化</a>
            </li>
            
            <li>
                <a class="link-info" href="/Phosphophyllite/articles/Minecraft/%E4%BD%BF%E7%94%A8%20Tan90-Proxy%20%E4%BB%A3%E7%90%86%20Minecraft%20%E6%9C%8D%E5%8A%A1%E5%99%A8.html">使用 Tan90-Proxy 代理 Minecraft 服务器</a>
            </li>
            
            <li>
                <a class="link-info" href="/Phosphophyllite/articles/Minecraft/Minecraft%20%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8B%E8%BD%BD%E9%A1%B5%E5%9C%B0%E5%9D%80.html">Minecraft 服务器下载页地址</a>
            </li>
            
            <li>
                <a class="link-info" href="/Phosphophyllite/articles/nginx/nginx%20%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E4%B8%8E%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE.html">nginx 常用命令与基础配置</a>
            </li>
            
            <li>
                <a class="link-info" href="/Phosphophyllite/articles/Linux%20%E5%91%BD%E4%BB%A4%E4%B8%8E%E9%85%8D%E7%BD%AE/%E5%88%B6%E4%BD%9C%20deb%20%E5%8C%85.html">制作 deb 包</a>
            </li>
            
            <li>
                <a class="link-info" href="/Phosphophyllite/articles/Windows%20%E5%91%BD%E4%BB%A4%E4%B8%8E%E9%85%8D%E7%BD%AE/Windows%20%E6%B3%A8%E5%86%8C%E8%A1%A8%E4%B8%AD%E6%B7%BB%E5%8A%A0%E8%87%AA%E5%B7%B1%E7%9A%84%E7%A8%8B%E5%BA%8F.html">Windows 注册表中添加自己的程序</a>
            </li>
            
        </ul>
    </div>
</div>


            </aside>
        </div>

        <footer class="no-print">
            

<div class="card" style="border-radius: 0;">
    <p class="github-brief card-text" style="margin: auto;">
        Powered by <i class="bi bi-arrow-through-heart-fill"></i> <a class="card-link link-success" href="https://github.com/hubenchang0515/Phosphophyllite" target="_blank">Phosphophyllite</a>
    </p>
</div>


        </footer>

        

<script>
    fetchUserInfo("hubenchang0515");
    scanTime();
</script>


    </body>
</html>